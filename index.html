<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frender</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f8f9fa;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .page {
            display: none;
            min-height: 100vh;
            background: white;
            position: relative;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            flex: 1;
            padding: 30px 20px;
            overflow-y: auto;
        }

        .welcome-content {
            text-align: center;
            padding-top: 60px;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .welcome-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #333;
        }

        .welcome-subtitle {
            color: #666;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .circle-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .circle-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .circle-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .circle-code {
            color: #667eea;
            font-family: monospace;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .circle-members {
            color: #666;
            font-size: 0.9rem;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .activity-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .activity-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .activity-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
        }

        .match-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
        }

        .match-partner {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .match-activities {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            max-width: 80%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }

        .message.partner {
            background: white;
            border-bottom-left-radius: 6px;
        }

        .message-sender {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 4px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input {
            flex: 1;
            margin: 0;
            border-radius: 20px;
            padding: 12px 16px;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 10px;
            z-index: 100;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 0.7rem;
        }

        .notification-dot {
            position: absolute;
            top: -2px;
            right: 20%;
            width: 8px;
            height: 8px;
            background: #ff4757;
            border-radius: 50%;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .setup-instructions p {
            color: #856404;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-form h3 {
            text-align: center;
            color: #333;
        }

        .btn-google {
            background: #4285f4;
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-google:hover {
            background: #357ae8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }

        .google-icon {
            font-size: 18px;
            background: white;
            color: #4285f4;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e9ecef;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .content {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Setup Page (Hidden by default) -->
        <div id="setup" class="page">
            <div class="header">
                <h1>🚀 Backend Setup</h1>
                <p>Configure your Supabase connection</p>
            </div>
            <div class="content">
                <div class="setup-instructions">
                    <h3>Quick Setup Instructions:</h3>
                    <p><strong>1.</strong> Go to <a href="https://supabase.com" target="_blank">supabase.com</a> and create a free account</p>
                    <p><strong>2.</strong> Create a new project</p>
                    <p><strong>3.</strong> Go to Settings → API and copy your:</p>
                    <p>• <code>anon public</code> key</p>
                    <p>• Project URL</p>
                    <p><strong>4.</strong> Paste them below and click Setup Database</p>
                </div>

                <div class="form-group">
                    <label for="supabaseUrl">Supabase URL:</label>
                    <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
                </div>

                <div class="form-group">
                    <label for="supabaseKey">Supabase Anon Key:</label>
                    <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                </div>

                <button class="btn-primary" onclick="setupDatabase()">Setup Database</button>
                <div id="setupStatus"></div>
            </div>
        </div>

        <!-- Login/Signup Page -->
        <div id="auth" class="page active">
            <div class="header">
                <h1>🎯 Activity Matcher</h1>
                <p>Connect through shared interests</p>
            </div>
            <div class="content">
                <div class="welcome-content">
                    <div class="welcome-icon">👋</div>
                    <h2 class="welcome-title">Welcome!</h2>
                    <p class="welcome-subtitle">Create an account or sign in to find friends who want to do the same activities as you.</p>
                    
                    <!-- Login Form -->
                    <div id="loginForm" class="auth-form">
                        <h3 style="margin-bottom: 20px;">Sign In</h3>
                        
                        <!-- Google Sign In Button -->
                        <button class="btn-google" onclick="signInWithGoogle()">
                            <span class="google-icon">G</span>
                            Continue with Google
                        </button>
                        
                        <div class="divider">
                            <span>or</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="loginEmail">Email:</label>
                            <input type="email" id="loginEmail" placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password:</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password">
                        </div>
                        <button class="btn-primary" onclick="signIn()">Sign In</button>
                        <button class="btn-secondary" onclick="showSignupForm()">Don't have an account? Sign Up</button>
                        <div id="loginStatus"></div>
                    </div>

                    <!-- Signup Form -->
                    <div id="signupForm" class="auth-form" style="display: none;">
                        <h3 style="margin-bottom: 20px;">Create Account</h3>
                        
                        <!-- Google Sign In Button -->
                        <button class="btn-google" onclick="signInWithGoogle()">
                            <span class="google-icon">G</span>
                            Continue with Google
                        </button>
                        
                        <div class="divider">
                            <span>or</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="signupUsername">Username:</label>
                            <input type="text" id="signupUsername" placeholder="Choose a username">
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email:</label>
                            <input type="email" id="signupEmail" placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password:</label>
                            <input type="password" id="signupPassword" placeholder="Choose a password (min 6 characters)">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password:</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm your password">
                        </div>
                        <button class="btn-primary" onclick="signUp()">Create Account</button>
                        <button class="btn-secondary" onclick="showLoginForm()">Already have an account? Sign In</button>
                        <div id="signupStatus"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Circles Hub Page -->
        <div id="circles" class="page">
            <div class="header">
                <h1>🔥 Your Circles</h1>
                <p>Friend groups</p>
                <button class="back-button" onclick="signOut()" style="right: 20px; left: auto;">⚙️</button>
            </div>
            <div class="content">
                <div id="circlesList"></div>
                
                <button class="btn-primary" onclick="navigateTo('createCircle')">Create New Circle</button>
                <button class="btn-secondary" onclick="navigateTo('joinCircle')">Join Circle</button>
            </div>
            <div class="bottom-nav">
                <div class="nav-items">
                    <div class="nav-item active" onclick="navigateTo('circles')">
                        <div class="nav-icon">👥</div>
                        <div class="nav-label">Circles</div>
                    </div>
                    <div class="nav-item" onclick="navigateTo('activities')">
                        <div class="nav-icon">🎯</div>
                        <div class="nav-label">Activities</div>
                    </div>
                    <div class="nav-item" onclick="navigateTo('matches')">
                        <div class="nav-icon">🔥</div>
                        <div class="nav-label">Matches</div>
                        <div id="matchNotificationDot" class="notification-dot" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Circle Page -->
        <div id="createCircle" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('circles')">←</button>
                <h1>Create Circle</h1>
                <p>Start a new friend group</p>
            </div>
            <div class="content">
                <div class="form-group">
                    <label for="circleName">Circle Name:</label>
                    <input type="text" id="circleName" placeholder="e.g., College Friends, Work Buddies">
                </div>
                
                <button class="btn-primary" onclick="createCircle()">Create Circle</button>
                <div id="createStatus"></div>
            </div>
        </div>

        <!-- Join Circle Page -->
        <div id="joinCircle" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('circles')">←</button>
                <h1>Join Circle</h1>
                <p>Enter a friend's circle code</p>
            </div>
            <div class="content">
                <div class="form-group">
                    <label for="joinCircleCode">Circle Code:</label>
                    <input type="text" id="joinCircleCode" placeholder="Enter 6-digit code" style="text-transform: uppercase;">
                </div>
                
                <button class="btn-primary" onclick="joinCircle()">Join Circle</button>
                <div id="joinStatus"></div>
            </div>
        </div>

        <!-- Circle Detail Page -->
        <div id="circleDetail" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('circles')">←</button>
                <h1 id="circleDetailName">Circle</h1>
                <p id="circleDetailMembers">Members</p>
            </div>
            <div class="content">
                <div class="form-group">
                    <label>Circle Code (share with friends):</label>
                    <input type="text" id="circleDetailCode" readonly style="font-family: monospace; font-size: 1.2rem; text-align: center;">
                </div>
                
                <h3 style="margin-bottom: 15px;">Add Custom Activity:</h3>
                <div class="form-group">
                    <input type="text" id="customActivity" placeholder="Activity name">
                </div>
                <button class="btn-secondary" onclick="addCustomActivity()">Add Activity</button>
                
                <button class="btn-primary" onclick="selectActivitiesForCircle()" style="margin-top: 30px;">Select Activities</button>
            </div>
        </div>

        <!-- Activities Selection Page -->
        <div id="activities" class="page">
            <div class="header">
                <button class="back-button" onclick="goBackFromActivities()">←</button>
                <h1 id="activitiesCircleName">Select Activities</h1>
                <p>What would you like to do?</p>
            </div>
            <div class="content">
                <div id="activitiesList" class="activity-grid"></div>
                <button class="btn-primary" onclick="submitActivities()" style="margin-top: 20px;">Submit Choices</button>
            </div>
        </div>

        <!-- Matches Page -->
        <div id="matches" class="page">
            <div class="header">
                <h1>🔥 Your Matches</h1>
                <p>People who are down</p>
            </div>
            <div class="content">
                <div id="matchesList"></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-items">
                    <div class="nav-item" onclick="navigateTo('circles')">
                        <div class="nav-icon">👥</div>
                        <div class="nav-label">Circles</div>
                    </div>
                    <div class="nav-item" onclick="navigateTo('activities')">
                        <div class="nav-icon">🎯</div>
                        <div class="nav-label">Activities</div>
                    </div>
                    <div class="nav-item active" onclick="navigateTo('matches')">
                        <div class="nav-icon">💖</div>
                        <div class="nav-label">Matches</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="chat" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('matches')">←</button>
                <h1 id="chatPartnerName">Chat</h1>
                <p id="chatActivities">Activities</p>
            </div>
            <div class="content" style="padding: 0;">
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
                        <button class="send-button" onclick="sendMessage()">→</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURE YOUR SUPABASE CREDENTIALS HERE
        const SUPABASE_URL = 'https://mrjodwrttsgbpxfsfxqi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yam9kd3J0dHNnYnB4ZnNmeHFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTE0NDQsImV4cCI6MjA3MzkyNzQ0NH0.BrThh6Ux6--1QPDhqrw5vJ_7NjUltXSGma1G1rrQOYY';

        // Global variables
        let supabase = null;
        let currentUser = null;
        let currentPage = 'auth'; // Start at auth instead of welcome
        let currentCircle = null;
        let currentMatch = null;
        let selectedActivities = [];

        // Default activities
        const defaultActivities = [
            'Coffee ☕', 'Movie 🎬', 'Hiking 🥾', 'Restaurant 🍽️', 'Shopping 🛍️',
            'Museum 🏛️', 'Concert 🎵', 'Beach 🏖️', 'Gaming 🎮', 'Book Club 📚',
            'Cooking 👨‍🍳', 'Workout 💪', 'Art Gallery 🎨', 'Karaoke 🎤', 'Mini Golf ⛳'
        ];

        // Database Setup
        async function setupDatabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const statusDiv = document.getElementById('setupStatus');

            if (!url || !key) {
                showStatus(statusDiv, 'Please enter both URL and API key', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Connecting to Supabase...', 'loading');

                // Initialize Supabase
                supabase = window.supabase.createClient(url, key);

                // Test connection with a simple query
                try {
                    const { data, error } = await supabase.from('users').select('id').limit(1);
                    
                    if (error && error.code === '42P01') {
                        // Tables don't exist, create them
                        showStatus(statusDiv, 'Database tables not found. Please run the SQL code manually.', 'error');
                        await createTables();
                        return;
                    } else if (error) {
                        // Other errors might be permission related, but connection works
                        console.log('Connection test error (this might be OK):', error);
                    }
                } catch (testError) {
                    console.log('Connection test failed, but proceeding anyway:', testError);
                }

                showStatus(statusDiv, 'Database setup complete!', 'success');
                setTimeout(() => navigateTo('welcome'), 1500);

            } catch (error) {
                console.error('Setup error:', error);
                showStatus(statusDiv, `Setup failed: ${error.message}`, 'error');
            }
        }

        async function createTables() {
            // Since you've already run the SQL, we'll show updated SQL for auth
            const statusDiv = document.getElementById('setupStatus');
            showStatus(statusDiv, `
                <div style="text-align: left; margin-top: 20px;">
                    <h3>⚠️ Database Update Required</h3>
                    <p>Since we're adding authentication, please run this updated SQL in your Supabase dashboard:</p>
                    <pre style="background: #f1f3f4; padding: 15px; border-radius: 8px; margin: 10px 0; overflow-x: auto; font-size: 12px;">
-- Drop existing users table and recreate with auth integration
DROP TABLE IF EXISTS messages CASCADE;
DROP TABLE IF EXISTS matches CASCADE;
DROP TABLE IF EXISTS user_activities CASCADE;
DROP TABLE IF EXISTS activities CASCADE;
DROP TABLE IF EXISTS circle_members CASCADE;
DROP TABLE IF EXISTS circles CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- Users table with authentication
CREATE TABLE users (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  auth_user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  username TEXT UNIQUE NOT NULL,
  email TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Circles table
CREATE TABLE circles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  code TEXT UNIQUE NOT NULL,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Circle members
CREATE TABLE circle_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  circle_id UUID REFERENCES circles(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(circle_id, user_id)
);

-- Activities
CREATE TABLE activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  circle_id UUID REFERENCES circles(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  is_custom BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- User activity selections
CREATE TABLE user_activities (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  circle_id UUID REFERENCES circles(id) ON DELETE CASCADE,
  activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
  selected_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, circle_id, activity_id)
);

-- Matches
CREATE TABLE matches (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  circle_id UUID REFERENCES circles(id) ON DELETE CASCADE,
  user1_id UUID REFERENCES users(id) ON DELETE CASCADE,
  user2_id UUID REFERENCES users(id) ON DELETE CASCADE,
  activity_id UUID REFERENCES activities(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Messages
CREATE TABLE messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  match_id UUID REFERENCES matches(id) ON DELETE CASCADE,
  sender_id UUID REFERENCES users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  sent_at TIMESTAMP DEFAULT NOW()
);

-- Enable Row Level Security
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE circles ENABLE ROW LEVEL SECURITY;
ALTER TABLE circle_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_activities ENABLE ROW LEVEL SECURITY;
ALTER TABLE matches ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;

-- RLS Policies for authenticated users
CREATE POLICY "Users can view all users" ON users FOR SELECT USING (true);
CREATE POLICY "Users can insert their own profile" ON users FOR INSERT WITH CHECK (auth.uid() = auth_user_id);
CREATE POLICY "Users can update their own profile" ON users FOR UPDATE USING (auth.uid() = auth_user_id);

CREATE POLICY "Users can view all circles they're members of" ON circles FOR SELECT USING (
  id IN (SELECT circle_id FROM circle_members WHERE user_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()))
);
CREATE POLICY "Users can create circles" ON circles FOR INSERT WITH CHECK (
  created_by = (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Users can view circle members" ON circle_members FOR SELECT USING (true);
CREATE POLICY "Users can join circles" ON circle_members FOR INSERT WITH CHECK (
  user_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Users can view activities in their circles" ON activities FOR SELECT USING (
  circle_id IN (SELECT circle_id FROM circle_members WHERE user_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()))
);
CREATE POLICY "Users can add activities to their circles" ON activities FOR INSERT WITH CHECK (
  circle_id IN (SELECT circle_id FROM circle_members WHERE user_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()))
);

CREATE POLICY "Users can manage their activity selections" ON user_activities FOR ALL USING (
  user_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
) WITH CHECK (
  user_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Users can view their matches" ON matches FOR SELECT USING (
  user1_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()) OR 
  user2_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
);
CREATE POLICY "Users can create matches" ON matches FOR INSERT WITH CHECK (
  user1_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()) OR 
  user2_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
);

CREATE POLICY "Users can view messages in their matches" ON messages FOR SELECT USING (
  match_id IN (
    SELECT id FROM matches WHERE 
    user1_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()) OR 
    user2_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
  )
);
CREATE POLICY "Users can send messages in their matches" ON messages FOR INSERT WITH CHECK (
  sender_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()) AND
  match_id IN (
    SELECT id FROM matches WHERE 
    user1_id = (SELECT id FROM users WHERE auth_user_id = auth.uid()) OR 
    user2_id = (SELECT id FROM users WHERE auth_user_id = auth.uid())
  )
);
                    </pre>
                    <p><strong>Important:</strong> This will delete existing data. After running the SQL, click Continue.</p>
                    <button class="btn-primary" onclick="navigateTo('auth')" style="margin-top: 15px;">Continue to App</button>
                </div>
            `, 'success');
        }

        // Utility functions
        function showStatus(element, message, type) {
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function navigateTo(page) {
            const currentElement = document.getElementById(currentPage);
            const nextElement = document.getElementById(page);
            
            currentElement.classList.remove('active');
            nextElement.classList.add('active');
            
            currentPage = page;
            
            // Load page-specific data
            switch(page) {
                case 'circles':
                    loadCircles();
                    break;
                case 'activities':
                    loadActivitiesPage();
                    break;
                case 'matches':
                    loadMatches();
                    break;
            }
        }

        // User functions - Remove the old completeOnboarding function since we have auth now

        // Circle functions
        async function loadCircles() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('circle_members')
                    .select(`
                        circles (
                            id,
                            name,
                            code,
                            created_at
                        )
                    `)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                const circlesList = document.getElementById('circlesList');
                
                if (!data || data.length === 0) {
                    circlesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">👥</div>
                            <p>No circles yet.<br>Create or join a circle to get started!</p>
                        </div>
                    `;
                    return;
                }

                circlesList.innerHTML = '';
                data.forEach(item => {
                    const circle = item.circles;
                    const circleDiv = document.createElement('div');
                    circleDiv.className = 'circle-card';
                    circleDiv.onclick = () => openCircleDetail(circle.id);
                    circleDiv.innerHTML = `
                        <div class="circle-name">${circle.name}</div>
                        <div class="circle-code">Code: ${circle.code}</div>
                        <div class="circle-members">Tap to manage</div>
                    `;
                    circlesList.appendChild(circleDiv);
                });

            } catch (error) {
                console.error('Error loading circles:', error);
            }
        }

        async function createCircle() {
            const circleName = document.getElementById('circleName').value.trim();
            const statusDiv = document.getElementById('createStatus');
            
            if (!circleName) {
                showStatus(statusDiv, 'Please enter a circle name', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Creating circle...', 'loading');

                const circleCode = Math.random().toString(36).substring(2, 8).toUpperCase();

                // Create circle
                const { data: circle, error: circleError } = await supabase
                    .from('circles')
                    .insert([{
                        name: circleName,
                        code: circleCode,
                        created_by: currentUser.id
                    }])
                    .select()
                    .single();

                if (circleError) throw circleError;

                // Add creator as member
                const { error: memberError } = await supabase
                    .from('circle_members')
                    .insert([{
                        circle_id: circle.id,
                        user_id: currentUser.id
                    }]);

                if (memberError) throw memberError;

                // Add default activities
                const activitiesData = defaultActivities.map(activity => ({
                    circle_id: circle.id,
                    name: activity,
                    is_custom: false
                }));

                const { error: activitiesError } = await supabase
                    .from('activities')
                    .insert(activitiesData);

                if (activitiesError) throw activitiesError;

                showStatus(statusDiv, `Circle created! Code: ${circleCode}`, 'success');
                document.getElementById('circleName').value = '';

                setTimeout(() => {
                    currentCircle = circle.id;
                    openCircleDetail(circle.id);
                }, 1500);

            } catch (error) {
                console.error('Error creating circle:', error);
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function joinCircle() {
            const code = document.getElementById('joinCircleCode').value.trim().toUpperCase();
            const statusDiv = document.getElementById('joinStatus');
            
            if (!code) {
                showStatus(statusDiv, 'Please enter a circle code', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Finding circle...', 'loading');

                // Find circle by code
                const { data: circle, error: findError } = await supabase
                    .from('circles')
                    .select('*')
                    .eq('code', code)
                    .single();

                if (findError) {
                    showStatus(statusDiv, 'Circle not found. Check the code.', 'error');
                    return;
                }

                // Check if already a member
                const { data: existingMember } = await supabase
                    .from('circle_members')
                    .select('*')
                    .eq('circle_id', circle.id)
                    .eq('user_id', currentUser.id)
                    .single();

                if (existingMember) {
                    showStatus(statusDiv, 'You are already a member of this circle', 'error');
                    return;
                }

                // Add as member
                const { error: memberError } = await supabase
                    .from('circle_members')
                    .insert([{
                        circle_id: circle.id,
                        user_id: currentUser.id
                    }]);

                if (memberError) throw memberError;

                showStatus(statusDiv, `Successfully joined "${circle.name}"!`, 'success');
                document.getElementById('joinCircleCode').value = '';

                setTimeout(() => navigateTo('circles'), 1500);

            } catch (error) {
                console.error('Error joining circle:', error);
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function openCircleDetail(circleId) {
            currentCircle = circleId;

            try {
                // Get circle details and member count
                const { data: circle, error } = await supabase
                    .from('circles')
                    .select(`
                        *,
                        circle_members(count)
                    `)
                    .eq('id', circleId)
                    .single();

                if (error) throw error;

                document.getElementById('circleDetailName').textContent = circle.name;
                document.getElementById('circleDetailMembers').textContent = `${circle.circle_members.length} members`;
                document.getElementById('circleDetailCode').value = circle.code;

                navigateTo('circleDetail');

            } catch (error) {
                console.error('Error loading circle details:', error);
            }
        }

        async function addCustomActivity() {
            const activity = document.getElementById('customActivity').value.trim();
            
            if (!activity || !currentCircle) {
                alert('Please enter an activity name');
                return;
            }

            try {
                // Check if activity already exists
                const { data: existing } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('circle_id', currentCircle)
                    .eq('name', activity)
                    .single();

                if (existing) {
                    alert('This activity already exists in the circle');
                    return;
                }

                // Add custom activity
                const { error } = await supabase
                    .from('activities')
                    .insert([{
                        circle_id: currentCircle,
                        name: activity,
                        is_custom: true
                    }]);

                if (error) throw error;

                document.getElementById('customActivity').value = '';
                alert('Activity added to circle!');

            } catch (error) {
                console.error('Error adding activity:', error);
                alert('Error adding activity. Please try again.');
            }
        }

        // Activities functions
        async function loadActivitiesPage() {
            if (!currentCircle) {
                // Show circle selection
                showCircleSelection();
                return;
            }

            await loadActivitiesForCircle(currentCircle);
        }

        async function showCircleSelection() {
            const activitiesList = document.getElementById('activitiesList');
            document.getElementById('activitiesCircleName').textContent = 'Choose Circle';

            try {
                const { data, error } = await supabase
                    .from('circle_members')
                    .select(`
                        circles (
                            id,
                            name
                        )
                    `)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                activitiesList.innerHTML = '';
                
                if (!data || data.length === 0) {
                    activitiesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🎯</div>
                            <p>Join a circle first to select activities!</p>
                        </div>
                    `;
                    return;
                }

                data.forEach(item => {
                    const circle = item.circles;
                    const circleDiv = document.createElement('div');
                    circleDiv.className = 'activity-card';
                    circleDiv.onclick = () => {
                        currentCircle = circle.id;
                        loadActivitiesForCircle(circle.id);
                    };
                    circleDiv.textContent = circle.name;
                    activitiesList.appendChild(circleDiv);
                });

            } catch (error) {
                console.error('Error loading circles:', error);
            }
        }

        async function loadActivitiesForCircle(circleId) {
            try {
                // Get circle name
                const { data: circle } = await supabase
                    .from('circles')
                    .select('name')
                    .eq('id', circleId)
                    .single();

                document.getElementById('activitiesCircleName').textContent = circle?.name || 'Activities';

                // Get activities for this circle
                const { data: activities, error } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('circle_id', circleId)
                    .order('is_custom', { ascending: true });

                if (error) throw error;

                // Get user's current selections
                const { data: userSelections } = await supabase
                    .from('user_activities')
                    .select('activity_id')
                    .eq('user_id', currentUser.id)
                    .eq('circle_id', circleId);

                const selectedIds = userSelections?.map(s => s.activity_id) || [];
                selectedActivities = activities?.filter(a => selectedIds.includes(a.id)) || [];

                const activitiesList = document.getElementById('activitiesList');
                activitiesList.innerHTML = '';

                activities?.forEach(activity => {
                    const activityDiv = document.createElement('div');
                    activityDiv.className = 'activity-card';
                    activityDiv.textContent = activity.name;
                    activityDiv.onclick = () => toggleActivity(activity, activityDiv);

                    if (selectedIds.includes(activity.id)) {
                        activityDiv.classList.add('selected');
                    }

                    activitiesList.appendChild(activityDiv);
                });

            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        function toggleActivity(activity, element) {
            const index = selectedActivities.findIndex(a => a.id === activity.id);
            
            if (index > -1) {
                selectedActivities.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedActivities.push(activity);
                element.classList.add('selected');
            }
        }

        async function submitActivities() {
            if (!currentCircle || selectedActivities.length === 0) {
                alert('Please select at least one activity');
                return;
            }

            try {
                // Delete existing selections
                await supabase
                    .from('user_activities')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('circle_id', currentCircle);

                // Insert new selections
                const selections = selectedActivities.map(activity => ({
                    user_id: currentUser.id,
                    circle_id: currentCircle,
                    activity_id: activity.id
                }));

                const { error } = await supabase
                    .from('user_activities')
                    .insert(selections);

                if (error) throw error;

                // Check for matches
                await checkForMatches();

                alert('Activities submitted! Check matches to see if you have any mutual interests.');
                navigateTo('matches');

            } catch (error) {
                console.error('Error submitting activities:', error);
                alert('Error submitting activities. Please try again.');
            }
        }

        async function checkForMatches() {
            try {
                // Find other users who selected the same activities in the same circle
                const { data: potentialMatches, error } = await supabase
                    .from('user_activities')
                    .select(`
                        user_id,
                        activity_id,
                        users(username),
                        activities(name)
                    `)
                    .eq('circle_id', currentCircle)
                    .neq('user_id', currentUser.id);

                if (error) throw error;

                // Group by user and find common activities
                const userActivities = {};
                potentialMatches?.forEach(match => {
                    if (!userActivities[match.user_id]) {
                        userActivities[match.user_id] = {
                            username: match.users.username,
                            activities: []
                        };
                    }
                    userActivities[match.user_id].activities.push({
                        id: match.activity_id,
                        name: match.activities.name
                    });
                });

                // Find common activities with current user
                const myActivityIds = selectedActivities.map(a => a.id);
                
                for (const [userId, userData] of Object.entries(userActivities)) {
                    const commonActivityIds = userData.activities
                        .filter(a => myActivityIds.includes(a.id))
                        .map(a => a.id);

                    if (commonActivityIds.length > 0) {
                        // Create matches for each common activity
                        for (const activityId of commonActivityIds) {
                            // Check if match already exists
                            const { data: existingMatch } = await supabase
                                .from('matches')
                                .select('*')
                                .eq('circle_id', currentCircle)
                                .eq('activity_id', activityId)
                                .or(`and(user1_id.eq.${currentUser.id},user2_id.eq.${userId}),and(user1_id.eq.${userId},user2_id.eq.${currentUser.id})`)
                                .single();

                            if (!existingMatch) {
                                await supabase
                                    .from('matches')
                                    .insert([{
                                        circle_id: currentCircle,
                                        user1_id: currentUser.id,
                                        user2_id: userId,
                                        activity_id: activityId
                                    }]);
                            }
                        }
                        
                        showMatchNotification();
                    }
                }

            } catch (error) {
                console.error('Error checking for matches:', error);
            }
        }

        // Matches functions
        async function loadMatches() {
            try {
                const { data: matches, error } = await supabase
                    .from('matches')
                    .select(`
                        id,
                        user1_id,
                        user2_id,
                        created_at,
                        activities(name),
                        user1:users!matches_user1_id_fkey(username),
                        user2:users!matches_user2_id_fkey(username)
                    `)
                    .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const matchesList = document.getElementById('matchesList');
                
                if (!matches || matches.length === 0) {
                    matchesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🔥</div>
                            <p>No matches yet.<br>Pick some activities to find people who are actually down!</p>
                        </div>
                    `;
                    return;
                }

                // Group matches by partner
                const matchesByPartner = {};
                matches.forEach(match => {
                    const partnerId = match.user1_id === currentUser.id ? match.user2_id : match.user1_id;
                    const partnerName = match.user1_id === currentUser.id ? match.user2.username : match.user1.username;
                    
                    if (!matchesByPartner[partnerId]) {
                        matchesByPartner[partnerId] = {
                            partnerId,
                            partnerName,
                            activities: [],
                            matchId: match.id
                        };
                    }
                    matchesByPartner[partnerId].activities.push(match.activities.name);
                });

                matchesList.innerHTML = '';
                Object.values(matchesByPartner).forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-card';
                    matchDiv.onclick = () => openChat(match.matchId, match.partnerName, match.activities);
                    matchDiv.innerHTML = `
                        <div class="match-partner">🎉 ${match.partnerName}</div>
                        <div class="match-activities">You both want to: ${match.activities.join(', ')}</div>
                        <div style="opacity: 0.8; font-size: 0.9rem;">Tap to chat and plan details</div>
                    `;
                    matchesList.appendChild(matchDiv);
                });

                hideMatchNotification();

            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        function showMatchNotification() {
            document.getElementById('matchNotificationDot').style.display = 'block';
        }

        function hideMatchNotification() {
            document.getElementById('matchNotificationDot').style.display = 'none';
        }

        // Chat functions
        async function openChat(matchId, partnerName, activities) {
            currentMatch = matchId;
            
            document.getElementById('chatPartnerName').textContent = partnerName;
            document.getElementById('chatActivities').textContent = activities.join(', ');
            
            await loadChat();
            navigateTo('chat');
        }

        async function loadChat() {
            if (!currentMatch) return;

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select(`
                        *,
                        sender:users(username)
                    `)
                    .eq('match_id', currentMatch)
                    .order('sent_at', { ascending: true });

                if (error) throw error;

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';

                messages?.forEach(message => {
                    const messageDiv = document.createElement('div');
                    const isOwn = message.sender_id === currentUser.id;
                    messageDiv.className = `message ${isOwn ? 'own' : 'partner'}`;
                    messageDiv.innerHTML = `
                        <div class="message-sender">${isOwn ? 'You' : message.sender.username}</div>
                        <div>${message.content}</div>
                        <div class="message-time">${new Date(message.sent_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    chatMessages.appendChild(messageDiv);
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function sendMessage() {
            if (!currentMatch) return;
            
            const messageText = document.getElementById('chatInput').value.trim();
            if (!messageText) return;

            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        match_id: currentMatch,
                        sender_id: currentUser.id,
                        content: messageText
                    }]);

                if (error) throw error;

                document.getElementById('chatInput').value = '';
                await loadChat();

            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Navigation helpers
        function selectActivitiesForCircle() {
            if (!currentCircle) return;
            navigateTo('activities');
        }

        function goBackFromActivities() {
            if (currentCircle) {
                navigateTo('circleDetail');
            } else {
                navigateTo('circles');
            }
        }

        // Initialize the app
        function init() {
            // Check if credentials are configured
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_KEY === 'YOUR_SUPABASE_KEY_HERE') {
                console.log('Supabase credentials not configured, showing setup page');
                currentPage = 'setup';
                document.getElementById('setup').classList.add('active');
                document.getElementById('auth').classList.remove('active');
                return;
            }

            // Check if we have Supabase loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded');
                document.getElementById('setupStatus').innerHTML = '<div class="error">Supabase library failed to load. Please refresh the page.</div>';
                return;
            }

            // Initialize Supabase with configured credentials
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase initialized successfully');
                
                // Check if user is already logged in
                checkAuthState();
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                currentPage = 'setup';
                document.getElementById('setup').classList.add('active');
                document.getElementById('auth').classList.remove('active');
            }
        }

        // Authentication functions
        async function checkAuthState() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (user) {
                    // Check if this is a Google OAuth user returning
                    if (user.app_metadata?.provider === 'google') {
                        await handleGoogleAuthReturn(user);
                    } else {
                        // Regular user, get their profile
                        const { data: profile } = await supabase
                            .from('users')
                            .select('*')
                            .eq('auth_user_id', user.id)
                            .single();
                        
                        if (profile) {
                            currentUser = profile;
                            navigateTo('circles');
                        } else {
                            // User exists in auth but not in users table, create profile
                            await handleGoogleAuthReturn(user);
                        }
                    }
                } else {
                    // No user logged in, stay on auth page
                    console.log('No user logged in');
                }
            } catch (error) {
                console.error('Error checking auth state:', error);
            }
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        function showLoginForm() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        async function signUp() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const statusDiv = document.getElementById('signupStatus');

            // Validation
            if (!username || !email || !password) {
                showStatus(statusDiv, 'Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showStatus(statusDiv, 'Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                showStatus(statusDiv, 'Password must be at least 6 characters', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Creating account...', 'loading');

                // Check if username is already taken
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    showStatus(statusDiv, 'Username already taken', 'error');
                    return;
                }

                // Sign up with Supabase Auth first
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });

                if (authError) throw authError;

                // Only create user profile if we have a confirmed user
                if (authData.user && authData.user.id) {
                    
                    // For email confirmation disabled or auto-confirmed users
                    if (authData.user.email_confirmed_at || !authData.user.confirmation_sent_at) {
                        try {
                            const { error: profileError } = await supabase
                                .from('users')
                                .insert([{
                                    username: username,
                                    auth_user_id: authData.user.id,
                                    email: email
                                }]);

                            if (profileError) {
                                console.error('Profile creation error:', profileError);
                                // Don't throw error, user can still login later
                            }
                        } catch (profileErr) {
                            console.error('Profile creation failed:', profileErr);
                        }
                        
                        showStatus(statusDiv, 'Account created successfully! You can now sign in.', 'success');
                    } else {
                        showStatus(statusDiv, 'Account created! Please check your email to confirm your account, then sign in.', 'success');
                    }
                    
                    // Auto-switch to login form after a delay
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById('loginEmail').value = email;
                    }, 3000);
                } else {
                    throw new Error('Account creation failed - no user returned');
                }

            } catch (error) {
                console.error('Signup error:', error);
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const statusDiv = document.getElementById('loginStatus');

            if (!email || !password) {
                showStatus(statusDiv, 'Please enter email and password', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Signing in...', 'loading');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                // Check if user profile exists, if not create it
                let profile = null;
                try {
                    const { data: existingProfile, error: profileError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('auth_user_id', data.user.id)
                        .single();

                    if (existingProfile) {
                        profile = existingProfile;
                    } else if (profileError && profileError.code === 'PGRST116') {
                        // Profile doesn't exist, create it
                        const username = data.user.email.split('@')[0] + Math.floor(Math.random() * 1000);
                        
                        const { data: newProfile, error: createError } = await supabase
                            .from('users')
                            .insert([{
                                username: username,
                                auth_user_id: data.user.id,
                                email: data.user.email
                            }])
                            .select()
                            .single();

                        if (createError) throw createError;
                        profile = newProfile;
                    } else {
                        throw profileError;
                    }
                } catch (profileErr) {
                    console.error('Profile error:', profileErr);
                    throw new Error('Could not load or create user profile');
                }

                currentUser = profile;
                showStatus(statusDiv, 'Welcome back!', 'success');
                
                setTimeout(() => {
                    navigateTo('circles');
                }, 1000);

            } catch (error) {
                console.error('Signin error:', error);
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;

                currentUser = null;
                currentCircle = null;
                currentMatch = null;
                selectedActivities = [];
                
                // Reset forms
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('signupUsername').value = '';
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showLoginForm();
                navigateTo('auth');
                
            } catch (error) {
                console.error('Signout error:', error);
                alert('Error signing out');
            }
        }

        async function signInWithGoogle() {
            try {
                const statusDiv = document.getElementById('loginStatus') || document.getElementById('signupStatus');
                showStatus(statusDiv, 'Connecting to Google...', 'loading');

                // Get the current URL for proper redirect
                const redirectTo = window.location.href;

                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectTo
                    }
                });

                if (error) throw error;

                // The redirect will happen automatically
                // When user returns, checkAuthState() will handle the rest

            } catch (error) {
                console.error('Google sign in error:', error);
                const statusDiv = document.getElementById('loginStatus') || document.getElementById('signupStatus');
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function handleGoogleAuthReturn(authUser) {
            try {
                // Check if user profile exists
                const { data: existingProfile } = await supabase
                    .from('users')
                    .select('*')
                    .eq('auth_user_id', authUser.id)
                    .single();

                if (existingProfile) {
                    currentUser = existingProfile;
                    navigateTo('circles');
                } else {
                    // Create new profile for Google user
                    const username = authUser.user_metadata?.full_name?.replace(/\s+/g, '').toLowerCase() || 
                                   authUser.email?.split('@')[0] || 
                                   'user' + Math.floor(Math.random() * 1000);

                    // Ensure username is unique
                    let finalUsername = username;
                    let counter = 1;
                    
                    while (true) {
                        const { data: existingUsername } = await supabase
                            .from('users')
                            .select('username')
                            .eq('username', finalUsername)
                            .single();
                        
                        if (!existingUsername) break;
                        
                        finalUsername = `${username}${counter}`;
                        counter++;
                    }

                    const { data: newProfile, error } = await supabase
                        .from('users')
                        .insert([{
                            username: finalUsername,
                            auth_user_id: authUser.id,
                            email: authUser.email
                        }])
                        .select()
                        .single();

                    if (error) throw error;

                    currentUser = newProfile;
                    navigateTo('circles');
                }

            } catch (error) {
                console.error('Error handling Google auth return:', error);
                signOut();
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>