<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Matcher</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f8f9fa;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .page {
            display: none;
            min-height: 100vh;
            background: white;
            position: relative;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            flex: 1;
            padding: 30px 20px;
            overflow-y: auto;
        }

        .welcome-content {
            text-align: center;
            padding-top: 60px;
        }

        .welcome-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #333;
        }

        .welcome-subtitle {
            color: #666;
            margin-bottom: 40px;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 16px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .circle-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .circle-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .circle-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .circle-code {
            color: #667eea;
            font-family: monospace;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .circle-members {
            color: #666;
            font-size: 0.9rem;
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .activity-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .activity-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .activity-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
        }

        .match-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            cursor: pointer;
        }

        .match-partner {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .match-activities {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            max-width: 80%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 6px;
        }

        .message.partner {
            background: white;
            border-bottom-left-radius: 6px;
        }

        .message-sender {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 4px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            gap: 10px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input {
            flex: 1;
            margin: 0;
            border-radius: 20px;
            padding: 12px 16px;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            cursor: pointer;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 10px;
            z-index: 100;
        }

        .nav-items {
            display: flex;
            justify-content: space-around;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .nav-icon {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .nav-label {
            font-size: 0.7rem;
        }

        .notification-dot {
            position: absolute;
            top: -2px;
            right: 20%;
            width: 8px;
            height: 8px;
            background: #ff4757;
            border-radius: 50%;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .setup-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .setup-instructions p {
            color: #856404;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .setup-instructions code {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }
            
            .content {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Setup Page -->
        <div id="setup" class="page active">
            <div class="header">
                <h1>üöÄ Backend Setup</h1>
                <p>Configure your Supabase connection</p>
            </div>
            <div class="content">
                <div class="setup-instructions">
                    <h3>Quick Setup Instructions:</h3>
                    <p><strong>1.</strong> Go to <a href="https://supabase.com" target="_blank">supabase.com</a> and create a free account</p>
                    <p><strong>2.</strong> Create a new project</p>
                    <p><strong>3.</strong> Go to Settings ‚Üí API and copy your:</p>
                    <p>‚Ä¢ <code>anon public</code> key</p>
                    <p>‚Ä¢ Project URL</p>
                    <p><strong>4.</strong> Paste them below and click Setup Database</p>
                </div>

                <div class="form-group">
                    <label for="supabaseUrl">Supabase URL:</label>
                    <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
                </div>

                <div class="form-group">
                    <label for="supabaseKey">Supabase Anon Key:</label>
                    <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                </div>

                <button class="btn-primary" onclick="setupDatabase()">Setup Database</button>
                <div id="setupStatus"></div>
            </div>
        </div>

        <!-- Welcome Page -->
        <div id="welcome" class="page">
            <div class="header">
                <h1>üéØ Activity Matcher</h1>
                <p>Connect through shared interests</p>
            </div>
            <div class="content">
                <div class="welcome-content">
                    <div class="welcome-icon">üëã</div>
                    <h2 class="welcome-title">Welcome!</h2>
                    <p class="welcome-subtitle">Find friends who want to do the same activities as you, without the awkwardness of asking directly.</p>
                    
                    <div class="form-group">
                        <label for="username">Choose your username:</label>
                        <input type="text" id="username" placeholder="Enter username">
                    </div>
                    
                    <button class="btn-primary" onclick="completeOnboarding()">Get Started</button>
                </div>
            </div>
        </div>

        <!-- Circles Hub Page -->
        <div id="circles" class="page">
            <div class="header">
                <h1>Your Circles</h1>
                <p>Friend groups for activity matching</p>
            </div>
            <div class="content">
                <div id="circlesList"></div>
                
                <button class="btn-primary" onclick="navigateTo('createCircle')">Create New Circle</button>
                <button class="btn-secondary" onclick="navigateTo('joinCircle')">Join Circle</button>
            </div>
            <div class="bottom-nav">
                <div class="nav-items">
                    <div class="nav-item active" onclick="navigateTo('circles')">
                        <div class="nav-icon">üë•</div>
                        <div class="nav-label">Circles</div>
                    </div>
                    <div class="nav-item" onclick="navigateTo('activities')">
                        <div class="nav-icon">üéØ</div>
                        <div class="nav-label">Activities</div>
                    </div>
                    <div class="nav-item" onclick="navigateTo('matches')">
                        <div class="nav-icon">üíñ</div>
                        <div class="nav-label">Matches</div>
                        <div id="matchNotificationDot" class="notification-dot" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Circle Page -->
        <div id="createCircle" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('circles')">‚Üê</button>
                <h1>Create Circle</h1>
                <p>Start a new friend group</p>
            </div>
            <div class="content">
                <div class="form-group">
                    <label for="circleName">Circle Name:</label>
                    <input type="text" id="circleName" placeholder="e.g., College Friends, Work Buddies">
                </div>
                
                <button class="btn-primary" onclick="createCircle()">Create Circle</button>
                <div id="createStatus"></div>
            </div>
        </div>

        <!-- Join Circle Page -->
        <div id="joinCircle" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('circles')">‚Üê</button>
                <h1>Join Circle</h1>
                <p>Enter a friend's circle code</p>
            </div>
            <div class="content">
                <div class="form-group">
                    <label for="joinCircleCode">Circle Code:</label>
                    <input type="text" id="joinCircleCode" placeholder="Enter 6-digit code" style="text-transform: uppercase;">
                </div>
                
                <button class="btn-primary" onclick="joinCircle()">Join Circle</button>
                <div id="joinStatus"></div>
            </div>
        </div>

        <!-- Circle Detail Page -->
        <div id="circleDetail" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('circles')">‚Üê</button>
                <h1 id="circleDetailName">Circle</h1>
                <p id="circleDetailMembers">Members</p>
            </div>
            <div class="content">
                <div class="form-group">
                    <label>Circle Code (share with friends):</label>
                    <input type="text" id="circleDetailCode" readonly style="font-family: monospace; font-size: 1.2rem; text-align: center;">
                </div>
                
                <h3 style="margin-bottom: 15px;">Add Custom Activity:</h3>
                <div class="form-group">
                    <input type="text" id="customActivity" placeholder="Activity name">
                </div>
                <button class="btn-secondary" onclick="addCustomActivity()">Add Activity</button>
                
                <button class="btn-primary" onclick="selectActivitiesForCircle()" style="margin-top: 30px;">Select Activities</button>
            </div>
        </div>

        <!-- Activities Selection Page -->
        <div id="activities" class="page">
            <div class="header">
                <button class="back-button" onclick="goBackFromActivities()">‚Üê</button>
                <h1 id="activitiesCircleName">Select Activities</h1>
                <p>What would you like to do?</p>
            </div>
            <div class="content">
                <div id="activitiesList" class="activity-grid"></div>
                <button class="btn-primary" onclick="submitActivities()" style="margin-top: 20px;">Submit Choices</button>
            </div>
        </div>

        <!-- Matches Page -->
        <div id="matches" class="page">
            <div class="header">
                <h1>Your Matches</h1>
                <p>Friends who want to do the same things</p>
            </div>
            <div class="content">
                <div id="matchesList"></div>
            </div>
            <div class="bottom-nav">
                <div class="nav-items">
                    <div class="nav-item" onclick="navigateTo('circles')">
                        <div class="nav-icon">üë•</div>
                        <div class="nav-label">Circles</div>
                    </div>
                    <div class="nav-item" onclick="navigateTo('activities')">
                        <div class="nav-icon">üéØ</div>
                        <div class="nav-label">Activities</div>
                    </div>
                    <div class="nav-item active" onclick="navigateTo('matches')">
                        <div class="nav-icon">üíñ</div>
                        <div class="nav-label">Matches</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Page -->
        <div id="chat" class="page">
            <div class="header">
                <button class="back-button" onclick="navigateTo('matches')">‚Üê</button>
                <h1 id="chatPartnerName">Chat</h1>
                <p id="chatActivities">Activities</p>
            </div>
            <div class="content" style="padding: 0;">
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Type your message..." onkeypress="handleChatKeypress(event)">
                        <button class="send-button" onclick="sendMessage()">‚Üí</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let supabase = null;
        let currentUser = null;
        let currentPage = 'setup';
        let currentCircle = null;
        let currentMatch = null;
        let selectedActivities = [];

        // Default activities
        const defaultActivities = [
            'Coffee ‚òï', 'Movie üé¨', 'Hiking ü•æ', 'Restaurant üçΩÔ∏è', 'Shopping üõçÔ∏è',
            'Museum üèõÔ∏è', 'Concert üéµ', 'Beach üèñÔ∏è', 'Gaming üéÆ', 'Book Club üìö',
            'Cooking üë®‚Äçüç≥', 'Workout üí™', 'Art Gallery üé®', 'Karaoke üé§', 'Mini Golf ‚õ≥'
        ];

        // Database Setup
        async function setupDatabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            const statusDiv = document.getElementById('setupStatus');

            if (!url || !key) {
                showStatus(statusDiv, 'Please enter both URL and API key', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Connecting to Supabase...', 'loading');

                // Initialize Supabase
                supabase = window.supabase.createClient(url, key);

                // Test connection with a simple query
                try {
                    const { data, error } = await supabase.from('users').select('id').limit(1);
                    
                    if (error && error.code === '42P01') {
                        // Tables don't exist, create them
                        showStatus(statusDiv, 'Database tables not found. Please run the SQL code manually.', 'error');
                        await createTables();
                        return;
                    } else if (error) {
                        // Other errors might be permission related, but connection works
                        console.log('Connection test error (this might be OK):', error);
                    }
                } catch (testError) {
                    console.log('Connection test failed, but proceeding anyway:', testError);
                }

                showStatus(statusDiv, 'Database setup complete!', 'success');
                setTimeout(() => navigateTo('welcome'), 1500);

            } catch (error) {
                console.error('Setup error:', error);
                showStatus(statusDiv, `Setup failed: ${error.message}`, 'error');
            }
        }

        async function createTables() {
            // Since you've already run the SQL, we'll assume tables exist
            const statusDiv = document.getElementById('setupStatus');
            showStatus(statusDiv, `
                <div style="text-align: left; margin-top: 20px;">
                    <h3>‚úÖ Great! You've run the SQL code</h3>
                    <p>Since you've already set up the database tables, click Continue to start using the app.</p>
                    <button class="btn-primary" onclick="navigateTo('welcome')" style="margin-top: 15px;">Continue to App</button>
                </div>
            `, 'success');
        }

        // Utility functions
        function showStatus(element, message, type) {
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function navigateTo(page) {
            const currentElement = document.getElementById(currentPage);
            const nextElement = document.getElementById(page);
            
            currentElement.classList.remove('active');
            nextElement.classList.add('active');
            
            currentPage = page;
            
            // Load page-specific data
            switch(page) {
                case 'circles':
                    loadCircles();
                    break;
                case 'activities':
                    loadActivitiesPage();
                    break;
                case 'matches':
                    loadMatches();
                    break;
            }
        }

        // User functions
        async function completeOnboarding() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            try {
                // Check if username exists
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (existingUser) {
                    currentUser = existingUser;
                } else {
                    // Create new user
                    const { data, error } = await supabase
                        .from('users')
                        .insert([{ username }])
                        .select()
                        .single();

                    if (error) throw error;
                    currentUser = data;
                }

                navigateTo('circles');
            } catch (error) {
                console.error('Onboarding error:', error);
                alert('Error creating user. Please try again.');
            }
        }

        // Circle functions
        async function loadCircles() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('circle_members')
                    .select(`
                        circles (
                            id,
                            name,
                            code,
                            created_at
                        )
                    `)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                const circlesList = document.getElementById('circlesList');
                
                if (!data || data.length === 0) {
                    circlesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <p>No circles yet.<br>Create or join a circle to get started!</p>
                        </div>
                    `;
                    return;
                }

                circlesList.innerHTML = '';
                data.forEach(item => {
                    const circle = item.circles;
                    const circleDiv = document.createElement('div');
                    circleDiv.className = 'circle-card';
                    circleDiv.onclick = () => openCircleDetail(circle.id);
                    circleDiv.innerHTML = `
                        <div class="circle-name">${circle.name}</div>
                        <div class="circle-code">Code: ${circle.code}</div>
                        <div class="circle-members">Tap to manage</div>
                    `;
                    circlesList.appendChild(circleDiv);
                });

            } catch (error) {
                console.error('Error loading circles:', error);
            }
        }

        async function createCircle() {
            const circleName = document.getElementById('circleName').value.trim();
            const statusDiv = document.getElementById('createStatus');
            
            if (!circleName) {
                showStatus(statusDiv, 'Please enter a circle name', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Creating circle...', 'loading');

                const circleCode = Math.random().toString(36).substring(2, 8).toUpperCase();

                // Create circle
                const { data: circle, error: circleError } = await supabase
                    .from('circles')
                    .insert([{
                        name: circleName,
                        code: circleCode,
                        created_by: currentUser.id
                    }])
                    .select()
                    .single();

                if (circleError) throw circleError;

                // Add creator as member
                const { error: memberError } = await supabase
                    .from('circle_members')
                    .insert([{
                        circle_id: circle.id,
                        user_id: currentUser.id
                    }]);

                if (memberError) throw memberError;

                // Add default activities
                const activitiesData = defaultActivities.map(activity => ({
                    circle_id: circle.id,
                    name: activity,
                    is_custom: false
                }));

                const { error: activitiesError } = await supabase
                    .from('activities')
                    .insert(activitiesData);

                if (activitiesError) throw activitiesError;

                showStatus(statusDiv, `Circle created! Code: ${circleCode}`, 'success');
                document.getElementById('circleName').value = '';

                setTimeout(() => {
                    currentCircle = circle.id;
                    openCircleDetail(circle.id);
                }, 1500);

            } catch (error) {
                console.error('Error creating circle:', error);
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function joinCircle() {
            const code = document.getElementById('joinCircleCode').value.trim().toUpperCase();
            const statusDiv = document.getElementById('joinStatus');
            
            if (!code) {
                showStatus(statusDiv, 'Please enter a circle code', 'error');
                return;
            }

            try {
                showStatus(statusDiv, 'Finding circle...', 'loading');

                // Find circle by code
                const { data: circle, error: findError } = await supabase
                    .from('circles')
                    .select('*')
                    .eq('code', code)
                    .single();

                if (findError) {
                    showStatus(statusDiv, 'Circle not found. Check the code.', 'error');
                    return;
                }

                // Check if already a member
                const { data: existingMember } = await supabase
                    .from('circle_members')
                    .select('*')
                    .eq('circle_id', circle.id)
                    .eq('user_id', currentUser.id)
                    .single();

                if (existingMember) {
                    showStatus(statusDiv, 'You are already a member of this circle', 'error');
                    return;
                }

                // Add as member
                const { error: memberError } = await supabase
                    .from('circle_members')
                    .insert([{
                        circle_id: circle.id,
                        user_id: currentUser.id
                    }]);

                if (memberError) throw memberError;

                showStatus(statusDiv, `Successfully joined "${circle.name}"!`, 'success');
                document.getElementById('joinCircleCode').value = '';

                setTimeout(() => navigateTo('circles'), 1500);

            } catch (error) {
                console.error('Error joining circle:', error);
                showStatus(statusDiv, `Error: ${error.message}`, 'error');
            }
        }

        async function openCircleDetail(circleId) {
            currentCircle = circleId;

            try {
                // Get circle details and member count
                const { data: circle, error } = await supabase
                    .from('circles')
                    .select(`
                        *,
                        circle_members(count)
                    `)
                    .eq('id', circleId)
                    .single();

                if (error) throw error;

                document.getElementById('circleDetailName').textContent = circle.name;
                document.getElementById('circleDetailMembers').textContent = `${circle.circle_members.length} members`;
                document.getElementById('circleDetailCode').value = circle.code;

                navigateTo('circleDetail');

            } catch (error) {
                console.error('Error loading circle details:', error);
            }
        }

        async function addCustomActivity() {
            const activity = document.getElementById('customActivity').value.trim();
            
            if (!activity || !currentCircle) {
                alert('Please enter an activity name');
                return;
            }

            try {
                // Check if activity already exists
                const { data: existing } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('circle_id', currentCircle)
                    .eq('name', activity)
                    .single();

                if (existing) {
                    alert('This activity already exists in the circle');
                    return;
                }

                // Add custom activity
                const { error } = await supabase
                    .from('activities')
                    .insert([{
                        circle_id: currentCircle,
                        name: activity,
                        is_custom: true
                    }]);

                if (error) throw error;

                document.getElementById('customActivity').value = '';
                alert('Activity added to circle!');

            } catch (error) {
                console.error('Error adding activity:', error);
                alert('Error adding activity. Please try again.');
            }
        }

        // Activities functions
        async function loadActivitiesPage() {
            if (!currentCircle) {
                // Show circle selection
                showCircleSelection();
                return;
            }

            await loadActivitiesForCircle(currentCircle);
        }

        async function showCircleSelection() {
            const activitiesList = document.getElementById('activitiesList');
            document.getElementById('activitiesCircleName').textContent = 'Choose Circle';

            try {
                const { data, error } = await supabase
                    .from('circle_members')
                    .select(`
                        circles (
                            id,
                            name
                        )
                    `)
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                activitiesList.innerHTML = '';
                
                if (!data || data.length === 0) {
                    activitiesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üéØ</div>
                            <p>Join a circle first to select activities!</p>
                        </div>
                    `;
                    return;
                }

                data.forEach(item => {
                    const circle = item.circles;
                    const circleDiv = document.createElement('div');
                    circleDiv.className = 'activity-card';
                    circleDiv.onclick = () => {
                        currentCircle = circle.id;
                        loadActivitiesForCircle(circle.id);
                    };
                    circleDiv.textContent = circle.name;
                    activitiesList.appendChild(circleDiv);
                });

            } catch (error) {
                console.error('Error loading circles:', error);
            }
        }

        async function loadActivitiesForCircle(circleId) {
            try {
                // Get circle name
                const { data: circle } = await supabase
                    .from('circles')
                    .select('name')
                    .eq('id', circleId)
                    .single();

                document.getElementById('activitiesCircleName').textContent = circle?.name || 'Activities';

                // Get activities for this circle
                const { data: activities, error } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('circle_id', circleId)
                    .order('is_custom', { ascending: true });

                if (error) throw error;

                // Get user's current selections
                const { data: userSelections } = await supabase
                    .from('user_activities')
                    .select('activity_id')
                    .eq('user_id', currentUser.id)
                    .eq('circle_id', circleId);

                const selectedIds = userSelections?.map(s => s.activity_id) || [];
                selectedActivities = activities?.filter(a => selectedIds.includes(a.id)) || [];

                const activitiesList = document.getElementById('activitiesList');
                activitiesList.innerHTML = '';

                activities?.forEach(activity => {
                    const activityDiv = document.createElement('div');
                    activityDiv.className = 'activity-card';
                    activityDiv.textContent = activity.name;
                    activityDiv.onclick = () => toggleActivity(activity, activityDiv);

                    if (selectedIds.includes(activity.id)) {
                        activityDiv.classList.add('selected');
                    }

                    activitiesList.appendChild(activityDiv);
                });

            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        function toggleActivity(activity, element) {
            const index = selectedActivities.findIndex(a => a.id === activity.id);
            
            if (index > -1) {
                selectedActivities.splice(index, 1);
                element.classList.remove('selected');
            } else {
                selectedActivities.push(activity);
                element.classList.add('selected');
            }
        }

        async function submitActivities() {
            if (!currentCircle || selectedActivities.length === 0) {
                alert('Please select at least one activity');
                return;
            }

            try {
                // Delete existing selections
                await supabase
                    .from('user_activities')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('circle_id', currentCircle);

                // Insert new selections
                const selections = selectedActivities.map(activity => ({
                    user_id: currentUser.id,
                    circle_id: currentCircle,
                    activity_id: activity.id
                }));

                const { error } = await supabase
                    .from('user_activities')
                    .insert(selections);

                if (error) throw error;

                // Check for matches
                await checkForMatches();

                alert('Activities submitted! Check matches to see if you have any mutual interests.');
                navigateTo('matches');

            } catch (error) {
                console.error('Error submitting activities:', error);
                alert('Error submitting activities. Please try again.');
            }
        }

        async function checkForMatches() {
            try {
                // Find other users who selected the same activities in the same circle
                const { data: potentialMatches, error } = await supabase
                    .from('user_activities')
                    .select(`
                        user_id,
                        activity_id,
                        users(username),
                        activities(name)
                    `)
                    .eq('circle_id', currentCircle)
                    .neq('user_id', currentUser.id);

                if (error) throw error;

                // Group by user and find common activities
                const userActivities = {};
                potentialMatches?.forEach(match => {
                    if (!userActivities[match.user_id]) {
                        userActivities[match.user_id] = {
                            username: match.users.username,
                            activities: []
                        };
                    }
                    userActivities[match.user_id].activities.push({
                        id: match.activity_id,
                        name: match.activities.name
                    });
                });

                // Find common activities with current user
                const myActivityIds = selectedActivities.map(a => a.id);
                
                for (const [userId, userData] of Object.entries(userActivities)) {
                    const commonActivityIds = userData.activities
                        .filter(a => myActivityIds.includes(a.id))
                        .map(a => a.id);

                    if (commonActivityIds.length > 0) {
                        // Create matches for each common activity
                        for (const activityId of commonActivityIds) {
                            // Check if match already exists
                            const { data: existingMatch } = await supabase
                                .from('matches')
                                .select('*')
                                .eq('circle_id', currentCircle)
                                .eq('activity_id', activityId)
                                .or(`and(user1_id.eq.${currentUser.id},user2_id.eq.${userId}),and(user1_id.eq.${userId},user2_id.eq.${currentUser.id})`)
                                .single();

                            if (!existingMatch) {
                                await supabase
                                    .from('matches')
                                    .insert([{
                                        circle_id: currentCircle,
                                        user1_id: currentUser.id,
                                        user2_id: userId,
                                        activity_id: activityId
                                    }]);
                            }
                        }
                        
                        showMatchNotification();
                    }
                }

            } catch (error) {
                console.error('Error checking for matches:', error);
            }
        }

        // Matches functions
        async function loadMatches() {
            try {
                const { data: matches, error } = await supabase
                    .from('matches')
                    .select(`
                        id,
                        user1_id,
                        user2_id,
                        created_at,
                        activities(name),
                        user1:users!matches_user1_id_fkey(username),
                        user2:users!matches_user2_id_fkey(username)
                    `)
                    .or(`user1_id.eq.${currentUser.id},user2_id.eq.${currentUser.id}`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const matchesList = document.getElementById('matchesList');
                
                if (!matches || matches.length === 0) {
                    matchesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üíñ</div>
                            <p>No matches yet.<br>Select some activities to find friends with similar interests!</p>
                        </div>
                    `;
                    return;
                }

                // Group matches by partner
                const matchesByPartner = {};
                matches.forEach(match => {
                    const partnerId = match.user1_id === currentUser.id ? match.user2_id : match.user1_id;
                    const partnerName = match.user1_id === currentUser.id ? match.user2.username : match.user1.username;
                    
                    if (!matchesByPartner[partnerId]) {
                        matchesByPartner[partnerId] = {
                            partnerId,
                            partnerName,
                            activities: [],
                            matchId: match.id
                        };
                    }
                    matchesByPartner[partnerId].activities.push(match.activities.name);
                });

                matchesList.innerHTML = '';
                Object.values(matchesByPartner).forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-card';
                    matchDiv.onclick = () => openChat(match.matchId, match.partnerName, match.activities);
                    matchDiv.innerHTML = `
                        <div class="match-partner">üéâ ${match.partnerName}</div>
                        <div class="match-activities">You both want to: ${match.activities.join(', ')}</div>
                        <div style="opacity: 0.8; font-size: 0.9rem;">Tap to chat and plan details</div>
                    `;
                    matchesList.appendChild(matchDiv);
                });

                hideMatchNotification();

            } catch (error) {
                console.error('Error loading matches:', error);
            }
        }

        function showMatchNotification() {
            document.getElementById('matchNotificationDot').style.display = 'block';
        }

        function hideMatchNotification() {
            document.getElementById('matchNotificationDot').style.display = 'none';
        }

        // Chat functions
        async function openChat(matchId, partnerName, activities) {
            currentMatch = matchId;
            
            document.getElementById('chatPartnerName').textContent = partnerName;
            document.getElementById('chatActivities').textContent = activities.join(', ');
            
            await loadChat();
            navigateTo('chat');
        }

        async function loadChat() {
            if (!currentMatch) return;

            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select(`
                        *,
                        sender:users(username)
                    `)
                    .eq('match_id', currentMatch)
                    .order('sent_at', { ascending: true });

                if (error) throw error;

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';

                messages?.forEach(message => {
                    const messageDiv = document.createElement('div');
                    const isOwn = message.sender_id === currentUser.id;
                    messageDiv.className = `message ${isOwn ? 'own' : 'partner'}`;
                    messageDiv.innerHTML = `
                        <div class="message-sender">${isOwn ? 'You' : message.sender.username}</div>
                        <div>${message.content}</div>
                        <div class="message-time">${new Date(message.sent_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                    `;
                    chatMessages.appendChild(messageDiv);
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        async function sendMessage() {
            if (!currentMatch) return;
            
            const messageText = document.getElementById('chatInput').value.trim();
            if (!messageText) return;

            try {
                const { error } = await supabase
                    .from('messages')
                    .insert([{
                        match_id: currentMatch,
                        sender_id: currentUser.id,
                        content: messageText
                    }]);

                if (error) throw error;

                document.getElementById('chatInput').value = '';
                await loadChat();

            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message. Please try again.');
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Navigation helpers
        function selectActivitiesForCircle() {
            if (!currentCircle) return;
            navigateTo('activities');
        }

        function goBackFromActivities() {
            if (currentCircle) {
                navigateTo('circleDetail');
            } else {
                navigateTo('circles');
            }
        }

        // Initialize the app
        function init() {
            // Check if we have Supabase loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase library not loaded');
                document.getElementById('setupStatus').innerHTML = '<div class="error">Supabase library failed to load. Please refresh the page.</div>';
                return;
            }
            console.log('Supabase library loaded successfully');
        }

        // Start the app
        init();
    </script>
</body>
</html>